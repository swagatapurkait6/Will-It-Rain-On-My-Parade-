<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Will It Rain On My Parade? | NASA Space Apps Challenge 2025</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0d1b2a 100%);
      color: #e0e6ed;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(2px 2px at 20% 30%, white, transparent),
        radial-gradient(2px 2px at 60% 70%, white, transparent),
        radial-gradient(1px 1px at 50% 50%, white, transparent),
        radial-gradient(1px 1px at 80% 10%, white, transparent),
        radial-gradient(2px 2px at 90% 60%, white, transparent),
        radial-gradient(1px 1px at 33% 80%, white, transparent);
      background-size: 200% 200%;
      animation: stars 60s linear infinite;
      opacity: 0.5;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes stars {
      from { background-position: 0 0; }
      to { background-position: -200% 200%; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    header {
      text-align: center;
      padding: 40px 20px;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      margin-bottom: 30px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .badge {
      display: inline-block;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      margin-top: 10px;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .info-box {
      margin-top: 15px;
      padding: 12px 20px;
      background: rgba(59, 130, 246, 0.15);
      border-radius: 10px;
      font-size: 0.9em;
      color: #94a3b8;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .card-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.4em;
      font-weight: 600;
      margin-bottom: 20px;
      color: #60a5fa;
    }

    #map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1;
      position: relative;
    }

    .location-btn {
      width: 100%;
      padding: 14px;
      margin-top: 15px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .location-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #94a3b8;
      font-weight: 500;
      font-size: 0.95em;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      color: #e0e6ed;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
      margin-top: 10px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #fca5a5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .results-section {
      grid-column: 1 / -1;
    }

    .activity-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .activity-result-card {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 16px;
      padding: 25px;
      border: 2px solid rgba(59, 130, 246, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .activity-result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }

    .activity-result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }

    .activity-result-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .activity-result-icon {
      font-size: 3em;
    }

    .activity-result-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #e0e6ed;
    }

    .safety-meter {
      margin-top: 15px;
    }

    .safety-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9em;
      color: #94a3b8;
    }

    .safety-percentage {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .safety-bar {
      height: 12px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .safety-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 1s ease, background 0.5s ease;
      box-shadow: 0 0 10px currentColor;
    }

    .safety-high {
      color: #4ade80;
    }

    .safety-high .safety-fill {
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }

    .safety-medium {
      color: #fbbf24;
    }

    .safety-medium .safety-fill {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .safety-low {
      color: #f87171;
    }

    .safety-low .safety-fill {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }

    .risk-factors {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(59, 130, 246, 0.2);
    }

    .risk-factor {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9em;
      color: #cbd5e1;
    }

    .risk-factor-value {
      font-weight: 600;
      color: #60a5fa;
    }

    .recommendation {
      margin-top: 15px;
      padding: 12px;
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3b82f6;
      border-radius: 6px;
      font-size: 0.9em;
      color: #cbd5e1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 12px;
      overflow: hidden;
    }

    th {
      background: rgba(59, 130, 246, 0.2);
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #60a5fa;
      font-size: 0.95em;
    }

    td {
      padding: 12px 15px;
      border-top: 1px solid rgba(59, 130, 246, 0.1);
      color: #cbd5e1;
    }

    tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .chart-container {
      background: rgba(30, 41, 59, 0.4);
      padding: 20px;
      border-radius: 12px;
      margin-top: 30px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .chart-container img {
      width: 100%;
      border-radius: 8px;
    }

    .risk-high {
      color: #f87171;
      font-weight: 600;
    }

    .risk-none {
      color: #4ade80;
    }

    footer {
      text-align: center;
      padding: 30px;
      color: #64748b;
      font-size: 0.9em;
      margin-top: 40px;
    }

    .coords-display {
      margin-top: 15px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 8px;
      font-size: 0.9em;
      color: #94a3b8;
      text-align: center;
    }

    .coords-display span {
      color: #60a5fa;
      font-weight: 600;
    }

    .forecast-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      color: #c4b5fd;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      margin-left: 10px;
      font-weight: 500;
    }

    .debug-panel {
      background: rgba(30, 41, 59, 0.6);
      border: 2px solid rgba(251, 191, 36, 0.4);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .debug-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #fbbf24;
      margin-bottom: 15px;
    }

    .debug-content {
      color: #cbd5e1;
      font-size: 0.9em;
      font-family: 'Courier New', monospace;
    }

    .debug-section {
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
      border-left: 3px solid #fbbf24;
    }

    .debug-section h4 {
      color: #fbbf24;
      margin-bottom: 8px;
      font-size: 1em;
    }

    .debug-section p {
      margin: 4px 0;
      color: #cbd5e1;
      line-height: 1.6;
    }

    .debug-section .highlight {
      color: #60a5fa;
      font-weight: 600;
    }

    @media (max-width: 968px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .logo {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Will It Rain On My Parade?</div>
      <div class="subtitle">Plan Your Perfect Outdoor Adventure with NASA Weather Data</div>
      <div class="badge">NASA Space Apps Challenge 2025</div>
      <div class="info-box">
        <strong>Linear Regression ML:</strong> Uses polynomial linear regression (degree 2) trained on 5 years of NASA historical data to predict future weather patterns. Calculations use weighted scoring across temperature, rainfall, wind, and humidity.
      </div>
    </header>

    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    <form method="POST">
      <div class="main-content">
        <div class="card">
          <div class="card-title">Select Location</div>
          <div id="map"></div>
          <div class="coords-display">
            <span id="coords-text">Click on the map or use your location</span>
          </div>
          <button type="button" class="location-btn" onclick="useMyLocation()">
            Use My Current Location
          </button>
          <input type="hidden" name="latitude" id="latitude">
          <input type="hidden" name="longitude" id="longitude">
        </div>

        <div class="card">
          <div class="card-title">Select Date Range</div>

          <div class="form-group">
            <label>Start Date</label>
            <input type="date" name="start_date" id="start_date" required>
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" name="end_date" id="end_date" required>
          </div>
          <button type="submit" class="submit-btn">Analyze Weather Risk</button>
        </div>
      </div>
    </form>

    {% if report %}
      {% if data_mode %}
      <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
        <div style="font-size: 1.1em; font-weight: 600; color: #60a5fa; margin-bottom: 10px;">
          {% if data_mode == 'historical' %}
            Mode: Historical Data Analysis
          {% elif data_mode == 'prediction' %}
            Mode: ML Prediction (Linear Regression)
          {% elif data_mode == 'hybrid' %}
            Mode: Hybrid (Historical + ML Predictions)
          {% endif %}
        </div>
        <div style="color: #cbd5e1; font-size: 0.95em;">
          {% if data_mode == 'historical' %}
            All dates are in the past. Showing actual NASA POWER historical weather data for the selected period.
          {% elif data_mode == 'prediction' %}
            All dates are in the future. Using Linear Regression trained on 5 years of historical data to predict weather patterns. Activity safety percentages calculated from predictions.
          {% elif data_mode == 'hybrid' %}
            Date range spans today. Combining actual historical data with ML predictions for future dates. Rows marked with "ML" badge are predictions.
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="card results-section">
        <div class="card-title">
          Activity Safety Analysis
          {% if data_mode == 'prediction' %}
            <span class="forecast-badge">ML Predictions Only</span>
          {% elif data_mode == 'hybrid' %}
            <span class="forecast-badge">Historical + ML Predictions</span>
          {% else %}
            <span class="forecast-badge">Historical Data</span>
          {% endif %}
        </div>
        
        <div class="activity-results" id="activity-results"></div>

        {% if training_info %}
        <div class="debug-panel">
          <div class="debug-title">ML Model Training Details & Safety Calculation Breakdown</div>
          <div class="debug-content">
            <div class="debug-section">
              <h4>Training Data Statistics</h4>
              {% for param, metrics in training_info.items() %}
              <p><span class="highlight">{{ param }}:</span> Trained on {{ metrics.samples }} samples | 
              Mean: {{ "%.2f"|format(metrics.mean) }} | 
              Std: {{ "%.2f"|format(metrics.std) }} | 
              Range: [{{ "%.2f"|format(metrics.min) }}, {{ "%.2f"|format(metrics.max) }}]</p>
              {% endfor %}
            </div>

            <div class="debug-section">
              <h4>Safety Score Calculation Method</h4>
              <p><span class="highlight">1. Individual Scores (0-100):</span></p>
              <p>   Temperature: 100 if in ideal range, decreases by 5 per degree deviation</p>
              <p>   Rain: 100 if no rain, decreases based on mm above ideal threshold</p>
              <p>   Wind: 100 if calm, decreases as wind speed increases</p>
              <p>   Humidity: 100 if in ideal range, decreases by 2 per percent deviation</p>
              <p style="margin-top: 10px;"><span class="highlight">2. Weighted Average:</span></p>
              <p>   Beach: Temp(30%) + Rain(40%) + Wind(20%) + Humidity(10%)</p>
              <p>   Hiking: Temp(25%) + Rain(35%) + Wind(25%) + Humidity(15%)</p>
              <p>   Picnic: Temp(25%) + Rain(45%) + Wind(20%) + Humidity(10%)</p>
              <p>   Fishing: Temp(20%) + Rain(25%) + Wind(35%) + Humidity(20%)</p>
              <p>   Camping: Temp(30%) + Rain(40%) + Wind(20%) + Humidity(10%)</p>
              <p>   Cycling: Temp(25%) + Rain(35%) + Wind(30%) + Humidity(10%)</p>
            </div>

            <div class="debug-section">
              <h4>Ideal Conditions for Activities</h4>
              <p><span class="highlight">Beach:</span> 25-35C, 0-2mm rain, 0-10m/s wind, 40-70% humidity</p>
              <p><span class="highlight">Hiking:</span> 15-28C, 0-5mm rain, 0-20m/s wind, 30-75% humidity</p>
              <p><span class="highlight">Picnic:</span> 18-30C, 0-1mm rain, 0-15m/s wind, 35-70% humidity</p>
              <p><span class="highlight">Fishing:</span> 10-30C, 0-8mm rain, 0-18m/s wind, 40-85% humidity</p>
              <p><span class="highlight">Camping:</span> 12-28C, 0-3mm rain, 0-18m/s wind, 35-75% humidity</p>
              <p><span class="highlight">Cycling:</span> 15-28C, 0-2mm rain, 0-15m/s wind, 35-70% humidity</p>
            </div>

            <div class="debug-section">
              <h4>Sample Weather Data (First 3 Days)</h4>
              {% for r in report[:3] %}
              <p><span class="highlight">{{ r.date }}{% if r.is_predicted %} (ML){% endif %}:</span> 
              Temp={{ "%.1f"|format(r.T2M) }}C, Rain={{ "%.1f"|format(r.PRECTOTCORR) }}mm, 
              Wind={{ "%.1f"|format(r.WS2M) }}m/s, Humidity={{ "%.1f"|format(r.RH2M) }}%</p>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if img_file %}
          <div class="chart-container">
            <img src="{{ img_file }}" alt="Weather Visualization">
          </div>
        {% endif %}

        <h3 style="margin-top: 40px; margin-bottom: 20px; color: #60a5fa; font-family: 'Space Grotesk', sans-serif;">Detailed Daily Forecast</h3>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Temperature (C)</th>
              <th>Rainfall (mm)</th>
              <th>Wind Speed (m/s)</th>
              <th>Humidity (%)</th>
              <th>Risk Assessment</th>
            </tr>
          </thead>
          <tbody>
            {% for r in report %}
            <tr {% if r.is_predicted %}style="background: rgba(139, 92, 246, 0.08);"{% endif %}>
              <td>
                <strong>{{ r.date }}</strong>
                {% if r.is_predicted %}
                  <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: rgba(139, 92, 246, 0.3); border-radius: 4px; font-size: 0.75em; color: #c4b5fd;">ML</span>
                {% endif %}
              </td>
              <td>{{ "%.1f"|format(r.T2M) }}</td>
              <td>{{ "%.1f"|format(r.PRECTOTCORR) }}</td>
              <td>{{ "%.1f"|format(r.WS2M) }}</td>
              <td>{{ "%.1f"|format(r.RH2M) }}</td>
              <td class="{% if r.risks != 'No major risks' %}risk-high{% else %}risk-none{% endif %}">
                {{ r.risks }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <script>
        const weatherData = {{ report | tojson | safe }};
        
        const activityRequirements = {
          beach: {
            icon: 'ðŸ–',
            name: 'Beach Day',
            ideal: { temp: [25, 35], rain: [0, 2], wind: [0, 10], humidity: [40, 70] },
            weights: { temp: 0.3, rain: 0.4, wind: 0.2, humidity: 0.1 }
          },
          hiking: {
            icon: 'ðŸ¥¾',
            name: 'Hiking',
            ideal: { temp: [15, 28], rain: [0, 5], wind: [0, 20], humidity: [30, 75] },
            weights: { temp: 0.25, rain: 0.35, wind: 0.25, humidity: 0.15 }
          },
          picnic: {
            icon: 'ðŸ§º',
            name: 'Picnic',
            ideal: { temp: [18, 30], rain: [0, 1], wind: [0, 15], humidity: [35, 70] },
            weights: { temp: 0.25, rain: 0.45, wind: 0.2, humidity: 0.1 }
          },
          fishing: {
            icon: 'ðŸŽ£',
            name: 'Fishing',
            ideal: { temp: [10, 30], rain: [0, 8], wind: [0, 18], humidity: [40, 85] },
            weights: { temp: 0.2, rain: 0.25, wind: 0.35, humidity: 0.2 }
          },
          camping: {
            icon: 'ðŸ•',
            name: 'Camping',
            ideal: { temp: [12, 28], rain: [0, 3], wind: [0, 18], humidity: [35, 75] },
            weights: { temp: 0.3, rain: 0.4, wind: 0.2, humidity: 0.1 }
          },
          cycling: {
            icon: 'ðŸš´',
            name: 'Cycling',
            ideal: { temp: [15, 28], rain: [0, 2], wind: [0, 15], humidity: [35, 70] },
            weights: { temp: 0.25, rain: 0.35, wind: 0.3, humidity: 0.1 }
          }
        };

        function calculateSafety(activity, data) {
          let tempScoreSum = 0, rainScoreSum = 0, windScoreSum = 0, humidityScoreSum = 0;
          let validDays = 0;
  
          const ideal = activityRequirements[activity].ideal;
          const weights = activityRequirements[activity].weights;
  
          data.forEach(day => {
            const temp = parseFloat(day.T2M);
            const rain = parseFloat(day.PRECTOTCORR) || 0;
            const wind = parseFloat(day.WS2M);
            const humidity = parseFloat(day.RH2M);
    
            if (isNaN(temp) || isNaN(wind) || isNaN(humidity)) return;
            
            validDays++;
    
            let dayTempScore = 0;
            if (temp >= ideal.temp[0] && temp <= ideal.temp[1]) {
              dayTempScore = 100;
            } else if (temp < ideal.temp[0]) {
              const deviation = ideal.temp[0] - temp;
              dayTempScore = Math.max(0, 100 - deviation * 5);
            } else {
              const deviation = temp - ideal.temp[1];
              dayTempScore = Math.max(0, 100 - deviation * 5);
            }
            tempScoreSum += dayTempScore;
    
            let dayRainScore = 0;
            if (rain === 0) {
              dayRainScore = 100;
            } else if (rain <= ideal.rain[1]) {
              dayRainScore = 100 - (rain / ideal.rain[1]) * 50;
            } else {
              const excess = rain - ideal.rain[1];
              dayRainScore = Math.max(0, 50 - excess * 5);
            }
            rainScoreSum += dayRainScore;
    
            let dayWindScore = 0;
            if (wind === 0) {
              dayWindScore = 100;
            } else if (wind <= ideal.wind[1]) {
              dayWindScore = 100 - (wind / ideal.wind[1]) * 40;
            } else {
              const excess = wind - ideal.wind[1];
              dayWindScore = Math.max(0, 60 - excess * 5);
            }
            windScoreSum += dayWindScore;
    
            let dayHumidityScore = 0;
            if (humidity >= ideal.humidity[0] && humidity <= ideal.humidity[1]) {
              dayHumidityScore = 100;
            } else if (humidity < ideal.humidity[0]) {
              const deviation = ideal.humidity[0] - humidity;
              dayHumidityScore = Math.max(0, 100 - deviation * 2);
            } else {
              const deviation = humidity - ideal.humidity[1];
              dayHumidityScore = Math.max(0, 100 - deviation * 2);
            }
            humidityScoreSum += dayHumidityScore;
          });
  
          if (validDays === 0) {
            return { total: 0, temp: 0, rain: 0, wind: 0, humidity: 0 };
          }
  
          const tempAvg = tempScoreSum / validDays;
          const rainAvg = rainScoreSum / validDays;
          const windAvg = windScoreSum / validDays;
          const humidityAvg = humidityScoreSum / validDays;
  
          const totalScore = (tempAvg * weights.temp) + (rainAvg * weights.rain) + 
                            (windAvg * weights.wind) + (humidityAvg * weights.humidity);
  
          return {
            total: Math.min(100, Math.max(0, Math.round(totalScore))),
            temp: Math.min(100, Math.max(0, Math.round(tempAvg))),
            rain: Math.min(100, Math.max(0, Math.round(rainAvg))),
            wind: Math.min(100, Math.max(0, Math.round(windAvg))),
            humidity: Math.min(100, Math.max(0, Math.round(humidityAvg)))
          };
        }

        function getRecommendation(safety) {
          if (safety >= 80) return "Perfect conditions! Highly recommended for this activity.";
          if (safety >= 60) return "Good conditions. Minor precautions advised.";
          if (safety >= 40) return "Acceptable conditions. Plan accordingly and monitor weather.";
          return "Not recommended. Consider rescheduling or choose alternative dates.";
        }

        function getSafetyClass(safety) {
          if (safety >= 70) return 'safety-high';
          if (safety >= 40) return 'safety-medium';
          return 'safety-low';
        }

        const activities = ['beach', 'hiking', 'picnic', 'fishing', 'camping', 'cycling'];
        const resultsContainer = document.getElementById('activity-results');
        
        activities.forEach(activity => {
          const safety = calculateSafety(activity, weatherData);
          const safetyClass = getSafetyClass(safety.total);
          const info = activityRequirements[activity];
          
          const card = document.createElement('div');
          card.className = 'activity-result-card';
          card.innerHTML = `
            <div class="activity-result-header">
              <span class="activity-result-icon">${info.icon}</span>
              <div class="activity-result-title">${info.name}</div>
            </div>
            <div class="safety-meter ${safetyClass}">
              <div class="safety-label">
                <span>Safety Score</span>
                <span class="safety-percentage">${safety.total}%</span>
              </div>
              <div class="safety-bar">
                <div class="safety-fill" style="width: ${safety.total}%"></div>
              </div>
            </div>
            <div class="risk-factors">
              <div class="risk-factor">
                <span>Temperature</span>
                <span class="risk-factor-value">${safety.temp}%</span>
              </div>
              <div class="risk-factor">
                <span>Rain Risk</span>
                <span class="risk-factor-value">${safety.rain}%</span>
              </div>
              <div class="risk-factor">
                <span>Wind Conditions</span>
                <span class="risk-factor-value">${safety.wind}%</span>
              </div>
              <div class="risk-factor">
                <span>Humidity</span>
                <span class="risk-factor-value">${safety.humidity}%</span>
              </div>
            </div>
            <div class="recommendation">
              ${getRecommendation(safety.total)}
            </div>
          `;
          resultsContainer.appendChild(card);
        });
      </script>
    {% endif %}

    <footer>
      Built for NASA Space Apps Challenge 2025 | Powered by NASA POWER API
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var map = L.map('map').setView([20, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      var marker;

      function updateCoords(lat, lon) {
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lon;
        document.getElementById("coords-text").innerHTML = 
          'Lat: <span>' + lat.toFixed(4) + '</span> | Lon: <span>' + lon.toFixed(4) + '</span>';
      }

      function onMapClick(e) {
        if (marker) { map.removeLayer(marker); }
        marker = L.marker(e.latlng).addTo(map);
        updateCoords(e.latlng.lat, e.latlng.lng);
      }

      window.useMyLocation = function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            map.setView([lat, lon], 10);
            if (marker) { map.removeLayer(marker); }
            marker = L.marker([lat, lon]).addTo(map);
            updateCoords(lat, lon);
          }, function(error) {
            alert("Unable to retrieve your location. Please click on the map instead.");
          });
        } else {
          alert("Geolocation is not supported by your browser.");
        }
      }

      map.on('click', onMapClick);

      document.querySelector('form').addEventListener('submit', function(e) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (startDate) {
          const startFormatted = startDate.replace(/-/g, '');
          const hiddenStart = document.createElement('input');
          hiddenStart.type = 'hidden';
          hiddenStart.name = 'start_date';
          hiddenStart.value = startFormatted;
          this.appendChild(hiddenStart);
          document.getElementById('start_date').name = '';
        }
        
        if (endDate) {
          const endFormatted = endDate.replace(/-/g, '');
          const hiddenEnd = document.createElement('input');
          hiddenEnd.type = 'hidden';
          hiddenEnd.name = 'end_date';
          hiddenEnd.value = endFormatted;
          this.appendChild(hiddenEnd);
          document.getElementById('end_date').name = '';
        }
      });
    });
  </script>
</body>
</html>
